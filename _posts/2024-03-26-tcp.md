---
layout: post
categories: [Network]
title: TCP
author: tngtied
date: 2024-03-26
---

TCP란 transport layer에서 결정되는 프로토콜 중 하나로, 안정적인 네트워크를 보장하고 UDP와 비교했을 때 연결지향성을 추구하는 프로토콜이다. TCP에서 신뢰성을 보장하는 요소로는 순서보장, 오류 검출 및 재전송, 흐름 제어, 혼잡 제어가 있다.
연결지향성은 연결이 처음 성립될 때 이루어지는 3 way handshake와 연결이 끝마쳐질때 이루어지는 4 way handshake를 통해 이루어진다. 이를 통해 TCP 세션이 성립된다.

# handshake

3 way handshake는 아래와 같이 이루어진다

1. 클라이언트가 서버에게 SYN x를 전송
2. 서버가 클라이어트에게 SYN y ACK x + 1을 전송
3. 클라이언트가 서버에게 ACK y + 1을 전송

이를 통해 송신 측과 수신 측 모두가 통신을 할 준비가 되었음을 확실시하고, 둘 사이의 연결을 보장한다.

4 way handshake는 아래와 같이 이루어진다.

1. 클라이언트가 서버에게 FIN을 전송하고 FIN_WAIT 상태가 된다.
2. 서버가 클라이언트에게 ACK을 전송하고 CLOSE_WAIT 상태가 된다.
3. 서버로부터 클라이언트에게 모든 데이터가 전송되었다면 서버에서 클라이언트로 FIN을 전송한다.
4. 클라이언트가 서버에게 ACK을 전송하고 TIME_WAIT 상태가 되어 전송된 데이터가 모두 수신되기를 기다린다.
   - ACK을 받은 서버는 소켓을 닫는다.
   - TIME_WAIT 상태가 끝난 이후 클라이언트도 소켓을 닫는다.

# 흐름 제어

흐름 제어를 통해서 데이터의 송신 속도를 제어하여 수신자의 버퍼를 넘기지 않도록 한다. 대표적인 방법으로는 Stop-and-Wait과 Sliding Window가 있다.

1. Stop-and-Wait
   수신자로부터 ACK이 온 뒤에야 패킷을 보내는 방식이다.
2. Sliding Window (Go Back N)
   수신 측에서 handshake 도중에 전달한 수신 측 윈도우 크기만큼 ACK 수신 없이 전송한다. 패킷 손실에 대해 대처하는 방법으로는 크게 selective repeat, go back n 둘이 있다.
   - selective repeat
     도중에 패킷이 손실된다면 수신측은 NAK을 전송함으로써 해당 패킷의 재전송을 요청하고, NAK을 수신한 송신측은 해당 패킷을 재전송한다.
   - go back N
     수신자가 ACK을 일정 시간 이상 동안 보내지 않을 경우 윈도우의 모든 패킷을 재전송하는 기법을 의미한다.

# 혼잡 제어

네트워크의 혼잡이란, 한 라우터에 데이터가 몰리거나 하는 현상이 발생해 데이터가 손실되고, 재전송을 야기해 혼잡도가 가중되는 등의 일을 의미한다. 이를 방지하기 위하여 네트워크에 전송하는 데이터의 속도를 조절하는 일을 혼잡 제어라고 한다.
송신의 크기를 늘려나가는 속도와 혼잡이 감지되었을 때 감소시키는 속도에 따라 AIMD, Slow Start, Fast Retransmit, Fast Recovery가 있다.

1. AIMD(Additive Increase, Multiplicative Decrease)
   패킷의 성공적인 전송마다 window 크기를 1씩 증가시키고, 실패가 발생할 시 window 크기를 반으로 줄이는 기법을 의미한다. 초기에 네트워크의 대역폭을 전부 활용하지 못하고, 네트워크의 혼잡을 미리 감지하지 못한다는 단점이 있다.
2. Slow Start
   패킷의 성공적인 전송마다 window의 크기를 2배씩 증가시킨다. 혼잡 현상이 발생하면 다시 window의 크기를 1로 떨어트리고 혼잡 현상이 발생한 window size의 절반까지만 2배 꼴로 증가시키고 이후로는 1씩 증가시킨다.
3. Fast Retransmit
   패킷의 손실이 발생하고 다음 패킷의 전송이 이루어질 경우, 손실 직전의 패킷에 대한 ACK을 수신측이 계속해서 전송함으로써, 손실을 신호하는 방법이다.
4. Fast Recovery
   slow start에서 혼잡한 상태가 되면 window size를 1로 줄이지 않고 반으로 줄이고 선형증가시키는 방법이다. 혼잡 상황의 발생 이후로는 순수한 AIMD 방식으로 동작하게 된다.

# TCP checksum

오류를 검출하는 데에 사용된다. 송신자는 데이터 전송 전에 Checksum을 계산해서 헤더에 추가하고, 수신자는 패킷을 받을 때마다 동일한 알고리즘을 사용하여 헤더의 체크섬과 비교한다. 이를 통해 데이터 무결성을 확인할 수 있다. 해당 체크섬은 TCP 헤더와 바디 패킷의 모든 비트에 대해 계산된다. 이에 반해, IP 체크섬은 IP 헤더에 대해서만 계산된다.

---

# HTTP와 TCP

순서 보장을 통해 올바른 렌더링을 해낼 수 있고, 패킷 손실 복구, 흐름 제어, 혼잡 제어와 같은 정책을 통해 안정적인 전송을 지원하기 때문에 안정성이 속도보다 중요하기 때문에 사용한다.

HTTP 3에서는 TCP 대신 UDP의 응용 형태인 QUIC 프로토콜 위에서 동작한다. UDP의 연결 설정 속도 및 빠른 패킷 재전송 및 피해 복구의 장점을 활용하면서도 QUIC 프로토콜을 활용하여 UDP의 단점을 보완한다.
